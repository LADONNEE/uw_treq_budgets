# Logging

## Logging Behavior

### Web Requests

Write log messages generated by web requests to the standard Laravel log file. This
log uses the most verbose (debug) log level.

    storage/logs/laravel.log

### Console / Artisan Commands

Write log messages from console commands (e.g. php artisan) to an alternate log file.

    storage/logs/updates.log

This log uses "notify" log level, meaning "debug" and "info" messages will not be 
written here.

If an artisan command is run without the --quiet option, log messages will also be 
written to standard output. Standard output receives all messages (level >= "debug").

This combination allows developer to see debug messages when commands are run 
interactively, but not spam server logs with chatty scheduled jobs.

### Rollbar

In production environment the project specific Rollbar Token is configured in the 
.env file. When that token is configured both web and console command logging will 
be sent to Rollbar API.

Default log level for Rollbar is "notice", this can also be overridden in .env.

### Rotation

We have no application level log rotation. Our deployment utility rotates logs with
each fresh deployment.


## Configuration

The Laravel file config/logging.php should be updated to use "flex" as the default 
log channel and add the "flex" configuration to the "channels" array.

    // config/logging.php 
    return [ 
        'default' => env('LOG_CHANNEL', 'flex'), 
        'channels' => [ 
            ... 
            'flex' => [ 
                'driver' => 'custom', 
                'via' => App\Logging\CreateFlexLogStack::class, 
                'path' => storage_path('logs/laravel.log'), 
                'path_cli' => storage_path('logs/update.log'), 
                'rollbar_token' => env('ROLLBAR_TOKEN'), 
                'rollbar_level' => env('ROLLBAR_LEVEL', 'notice'), 
            ], 
        ],
    ];

In the .env file, if you previously had a LOG_CHANNEL override, remove it. If you 
want to send errors to Rollbar add the project specific ROLLBAR_TOKEN.

    # .env file
    
    # if you have something like this, remove it to opt into "flex" log
    #LOG_CHANNEL=notify
    
    # if you want to use Rollbar (e.g. production) add the project access token
    ROLLBAR_TOKEN=
    
    # if you want to change Rollbar log level from "notice" you can
    #ROLLBAR_LEVEL=debug


## Console / Artisan Command Logging

The base class `CommandWithLogging` will help set up the optional standard output 
logging.

The decision to use STDOUT or not is based on whether --quiet option was set. But
this is not known until immediately before your command's handle() method is called,
so your code will need to call a CommandWithLogging method from within your handle().
You have two options.

### Call getLog()

CommandWithLogging::getLog() method returns the log instance but will also add STDOUT 
if needed. If you are creating objects that need a log instance this is the simple
solution.

    class MyCommand extends CommandWithLogging
    {
        public function handle(Term $sws)
        {
            $job = new MyUpdateJob($this->getLog());
            $job->run();
        }
    }

### Call logToStdOut()

Alternately, if you don't need a direct log instance (for example your job is using
Laravel Log facade) you can call logToStdOut() to add STDOUT if needed.

    class MyCommand extends CommandWithLogging
    {
        public function handle()
        {
            $this->logToStdOut();
            Log::debug('This command does very little');
        }
    }
